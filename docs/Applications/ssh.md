# SSH

SSH is a secure protocol and the most common way of remotely administering Linux servers and other equipment.
SSH uses **symmetrical encryption**, which means a single key encrypts outbound messages to and inbound messages from the other participant.

The SSH session is established in two stages:

1. Negotiate session key
2. Authenticate the user

The symmetrical key used for the session, called the **session key**, is negotiated through the asymmetrical [Diffie-Hellman](#diffie-hellman) key exchange protocol.
This algorithm combines private data with public data from the other participant to produce the identical, session key, and the encryption used for the rest of the connection is called **binary packet protocol**.

The simplest and least secure method of authentication is password-based.
Although the password is sent through the encryption, it is still considered vulnerable to brute-force attacks.

SSH **key pairs**, which are asymmetric, are recommended. These are what is generated by [**ssh-keygen**](#ssh-keygen), and stored in **$HOME/.ssh** with names that reflect the encryption algorithm, i.e. "id_rsa" and "id_rsa.pub", etc.
The public key, used to **encrypt** data for the private key, can be freely shared.
In fact, this is the purpose of **ssh-copy-id**, to share the public key.
However the private key, which is used for decryption, must be kept secret.

The client sends an ID for the key pair it wants to authenticate with to the server. The server then checks the **authorized_keys** file of the requested account for the ID.
A random number is generated by the server, encrypted with the public key, and sent to the client.
The client then decrypts the random number and combines it with the shared session key and calculates the MD5 hash.
This hash is then sent back to the server, which checks the calculation.


Note that the SSH server is named **openssh-server** in Ubuntu repos and the service is named **ssh**, as opposed to **sshd** on Red Hat systems.

## Cryptography

The SSH Transport Layer Protocol or SSH-TRANS refers to the sequence of events that occurs to establish a SSH connection.

The first and most trivial step of the protocol is to agree on a protocol version.

The next step of the protocol is to arrange the basic security properties of SSH as well as the session parameters used to achieve them.
These parameters are set during the **key exchange**.


On RHEL-derivative systems (including Fedora [since Fedora 26](https://fedoraproject.org/wiki/Changes/OpenSSH_Crypto_Policy)), system-wide cryptographic policies are set using the [crypto-policies packages](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/security_hardening/using-the-system-wide-cryptographic-policies_security-hardening).
This policy overrides settings for a variety of applications, including OpenSSH.

The policy is changed by changing the value ("LEGACY", "DEFAULT", "FUTURE", etc) in the config at **/etc/crypto-policies/config**, then updating the configuration.

```sh
sudo update-crypto-policies
```

It is possible to [opt out of system-wide cryptographic policies per application](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/security_hardening/using-the-system-wide-cryptographic-policies_security-hardening#examples-of-opting-out-of-system-wide-crypto-policies_using-the-system-wide-cryptographic-policies) using a variety of techniques.

Apparently a line beginning with **`CRYPTO_POLICY=`** is to be found in the config at **/etc/sysconfig/sshd** on RHEL 8.


**Message authentication code** (MAC) algorithms, also known as integrity-checking algorithms, can be specified after the **MACs** keyword in the server configuration.

- **HMAC** (hash-based message authentication code) is a widely used algorithm that combines a cryptographic hash (message digest) with a secret key and that is used in protocols like IPsec, SSL/TLS, and SSH for message integrity verification. HMAC can be based on message digest algorithms such as MD5, SHA1, SHA256, etc.
- **MD5** was oncely a popular MAC algorithm but is now considered weak due to its vulnerability to collision attacks

```sh
# Display available message authentication code algorithms
ssh -Q mac # (1)

# Connect to a server providing a comma-delimited list of MAC algorithms in order of preference
ssh $SERVER -m $MACS
```

1. 
```
--8<-- "includes/Output/ssh-Q-mac"
```

Block cipher algorithms (or ciphers) can be specified after the **Ciphers** keyword.

??? info "Naming conventions"

    Nonstandard MAC algorithms are appended with a domain suffix resembling an email address (i.e. "hmac-ripemd160@openssh.com").

    Ciphers use a conventional naming scheme that encodes the algorithm and variable parameters.
    For example "cast128-12-cbc@ssh.com" refers to the CAST algorithm in 128 bit key length, 12 rounds of encryption, and using the cipher block chaining (CBC) mode of operation.
    Like nonstandard MAC algorithms, nonstandard ciphers must also have a suffix with a leading @ character indicating the domain that defined the cipher.



```sh title="Inspect available cryptographic algorithms"
# Ciphers
ssh -Q cipher

# Host signature algorithms
ssh -Q HostbasedAcceptedAlgorithms

ssh -Q HostKeyAlgorithms

# Key exchange algorithms
ssh -Q KexAlgorithms

# Public key signature authentication algorithms
ssh -Q PubkeyAcceptedAlgorithms
```


## Tasks

<div class="grid cards" markdown>

-   #### Connecting to a server

    ---

    ```sh
    
    ```

</div>

#### Port forwarding
:   
    --8<-- "includes/Tasks/ssh-port-forwarding.md"

#### X forwarding
:   
    --8<-- "includes/Tasks/X-forwarding.md"

#### fail2ban
:   
    --8<-- "includes/Tasks/fail2ban.md"

#### Login messages

There are two messages that can be displayed to the remote user upon initiating a SSH session: the **banner** and the **message of the day**.

The banner can be suppressed in recent versions of OpenSSH using **-q** or by modifying the **LogLevel**

```sh
# Suppress the banner
ssh -q $SERVER
ssh -o 'LogLevel=QUIET' $SERVER
```

In order to suppress the message of the day, create an empty file at **~/.hushlogin**

## Configuration

Server and client configuration both use the same set of [keywords](https://man.openbsd.org/ssh_config) that can be defined inline on invocation or in config files.

### Client configuration
:   

    By default, client configurations are stored in each user's **~/.ssh** directory, which also contains public and private key pairs.
    This directory must have 700 permissions, and importnat files like private keys or known\_hosts must have 600.

    ```sh
    Host home
        HostName 192.168.1.1
        User root
        Port 50022
        SetEnv BAT_THEME=OneHalfLight # (1)
        LocalForward 8080 localhost:8080 # (2)
    ```

    1. [**SetEnv**](https://man.openbsd.org/ssh_config#SetEnv) allows environment variables to be set in a remote session. 
    However, these same environment variables must be explicitly specified in [**AcceptEnv**](https://man.openbsd.org/sshd_config#AcceptEnv) key of the [server configuration](#server-configuration).
    This entry will set a specific syntax highlighting theme for use on the bat CLI utility.
    ```sh title="/etc/ssh/sshd_config"
    AcceptEnv BAT_THEME
    ```
    2. The use of [**LocalForward**](https://man.openbsd.org/ssh_config#LocalForward) here is equivalent to the use of the **-L** option at the command-line:
    ```sh
    ssh -L 8080:localhost:8080 $SERVER
    ```

#### Transient servers
:   
    Prevent recording a transient server to the client's known hosts file.
    This is useful when SSHing to many hosts from a single client, say while managing a corporate environment.

    ```sh
    UserKnownHostsFile /dev/null # (1)
    StrictHostKeyChecking no # (2)
    ```

    1. [**UserKnownHostsFile**](https://man.openbsd.org/ssh_config#UserKnownHostsFile)
    2. [**StrictHostKeyChecking**](https://man.openbsd.org/ssh_config#StrictHostKeyChecking)

#### Canonical hostname
:   
    In [corporate environments with verbose domain names](https://serverfault.com/questions/363055/regular-expression-matching-in-ssh-config), [**canonical hostnames**](https://man.openbsd.org/ssh_config#CanonicalDomains) can be configured to automatically append repetitive domain names ("canonicalize") to destination hosts.

    In this example, any connection made to a hostname beginning with "server" will append "example.com".

    ```sh
    Host server*
        CanonicalDomains example.com # (1)
        CanonicalizeHostname always # (2)
    ```

    1. [**CanonicalDomains**](https://man.openbsd.org/ssh_config#CanonicalDomains)
    2. [**CanonicalizeHostname**](https://man.openbsd.org/ssh_config#CanonicalizeHostname)

### Server configuration
:   

    ```sh
    --8<-- "includes/Configs/sshd_config"
    ```

    ```sh
    # Check server configuration, outputting settings to STDOUT
    sshd -T
    ```

## Commands

```sh title="ssh"
# Display available signature algorithms
ssh -Q PubkeyAcceptedAlgorithms

# X Forwarding
ssh -Y user@host
```

**ssh-keygen** is used to generate public and private authentication key pairs.

```sh title="ssh-keygen"
--8<-- "includes/Commands/s/ssh-keygen.sh"
```

[**ssh-add**](https://www.ssh.com/academy/ssh/add-command) and **ssh-agent** are often used together to manage SSH identities as in the following snippet.

```sh
eval $(ssh-agent); ssh-add <(cat "$(keyFile.secureFilePath)")
```

- **ssh-agent** is the OpenSSH authentication agent and a [helper program](https://www.ssh.com/academy/ssh/agent) that keeps track of identity keys and passphrases, allowing them to be used without further interaction, similar in principle to SSO.
- **ssh-add** adds private key identities to ssh-agent
When run without arguments, ssh-add adds the private keys found in **~/.ssh**.

Running ssh-agent produces output that is meant to be used with the **eval** command in order to set the environment variables **SSH\_AGENT\_PID** and **SSH\_AUTH\_SOCK**, which are needed by ssh-add.

If only a single process is running, the **-k** option will kill it (although it is possible to fork multiple ssh-agent processes).

```sh
# Equivalent to kill $SSH_AGENT_PID
ssh-agent -k 
```


**ssh-copy-id** copies the SSH public key to a specified account's **~/.ssh/authorized_keys** file.

??? info "SSH public key management in Windows"

    In Windows, ssh-copy-id is not available, so a workaround is to simply [pipe the public key](https://www.chrisjhart.com/Windows-10-ssh-copy-id/) over SSH itself.

    ```powershell
    Get-Content $env:USERPROFILE\.ssh\id_rsa.pub | ssh $SERVER "cat >> .ssh/authorized_keys"
    ```


